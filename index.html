<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Unit 3 ‚Äì Present Perfect (Ripasso + Quiz immediato)</title>
  <style>
    :root{
      --bg:#0b1020;
      --text:rgba(255,255,255,0.92);
      --muted:rgba(255,255,255,0.65);
      --line:rgba(255,255,255,0.14);
      --shadow:0 10px 30px rgba(0,0,0,0.35);
      --radius:18px;
      --ok:rgba(0,255,170,0.85);
      --bad:rgba(255,90,90,0.9);
      --warn:rgba(255,210,80,0.9);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{ box-sizing:border-box; }
    body{
      margin:0; font-family:var(--sans); color:var(--text);
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(80,120,255,0.20), transparent 60%),
        radial-gradient(900px 600px at 90% 20%, rgba(0,255,170,0.14), transparent 55%),
        radial-gradient(900px 700px at 40% 90%, rgba(255,90,90,0.12), transparent 55%),
        var(--bg);
      min-height:100vh; padding:22px;
    }
    header{
      max-width:980px; margin:0 auto 18px auto;
      display:flex; gap:14px; align-items:flex-start; justify-content:space-between; flex-wrap:wrap;
    }
    .title{
      flex:1 1 560px;
      background:linear-gradient(135deg, rgba(255,255,255,0.14), rgba(255,255,255,0.06));
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:16px 18px;
      box-shadow:var(--shadow);
    }
    h1{ margin:0 0 8px 0; font-size:20px; letter-spacing:.2px; }
    .subtitle{ color:var(--muted); font-size:13.5px; line-height:1.35; }
    .panel{
      flex:0 1 360px; min-width:280px;
      background:linear-gradient(135deg, rgba(255,255,255,0.10), rgba(255,255,255,0.05));
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:14px 16px;
      box-shadow:var(--shadow);
    }
    .row{ display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
    .pill{
      font-family:var(--mono); font-size:12px;
      padding:6px 10px; border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,0.06);
    }
    .btn{
      border:1px solid var(--line);
      background:rgba(255,255,255,0.12);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      font-weight:700;
      transition:.15s transform, .15s background;
      user-select:none;
    }
    .btn:hover{ background:rgba(255,255,255,0.18); transform:translateY(-1px); }
    .btn:active{ transform:translateY(0); }
    main{ max-width:980px; margin:0 auto; display:flex; flex-direction:column; gap:14px; }

    .card{
      border:1px solid var(--line);
      border-radius:var(--radius);
      background:linear-gradient(135deg, rgba(255,255,255,0.10), rgba(255,255,255,0.04));
      box-shadow:var(--shadow);
      padding:16px 18px;
    }
    .card h2{
      margin:0 0 10px 0; font-size:16px;
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
    }
    .hint{ color:var(--muted); font-size:13px; line-height:1.45; margin:0 0 10px 0; }

    /* Slides */
    .slides{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    @media (max-width:760px){ .slides{ grid-template-columns:1fr; } }
    .slide{
      border:1px solid var(--line);
      border-radius:16px;
      background:rgba(255,255,255,0.05);
      padding:14px 14px;
    }
    .slide .stitle{ font-weight:850; margin:0 0 6px 0; }
    .slide ul{ margin:8px 0 0 18px; padding:0; color:rgba(255,255,255,0.88); }
    .slide li{ margin:6px 0; }
    .mono{ font-family:var(--mono); font-size:12.5px; color:rgba(255,255,255,0.86); }

    /* Questions */
    .q{
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px 12px;
      background:rgba(255,255,255,0.05);
      margin:10px 0;
    }
    .qtitle{ font-weight:800; margin-bottom:8px; }
    .prompt{
      font-family:var(--mono);
      font-size:12.5px;
      color:rgba(255,255,255,0.9);
      background:rgba(0,0,0,0.16);
      border:1px solid var(--line);
      padding:10px 10px;
      border-radius:12px;
      margin:8px 0 10px 0;
      white-space:pre-wrap;
    }
    label{ display:block; margin:7px 0; cursor:pointer; }
    input[type="radio"]{ transform:translateY(1px); margin-right:8px; }

    .feedback{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,0.04);
      font-size:13.5px; line-height:1.35;
    }
    .ok{ border-color:rgba(0,255,170,0.35); background:rgba(0,255,170,0.10); }
    .bad{ border-color:rgba(255,90,90,0.35); background:rgba(255,90,90,0.10); }
    .warn{ border-color:rgba(255,210,80,0.35); background:rgba(255,210,80,0.10); }
    .small{ font-size:12.5px; color:var(--muted); }

    details{
      margin-top:8px;
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px 12px;
      background:rgba(255,255,255,0.04);
    }
    summary{ cursor:pointer; font-weight:850; }

    .recapList{
      margin: 0;
      padding: 0;
      list-style: none;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .recapItem{
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px 12px;
      background:rgba(255,255,255,0.04);
    }
    .recapItem b{ font-family:var(--mono); }
  </style>
</head>
<body>

<header>
  <div class="title">
    <h1>Unit 3 ‚Äì Present Perfect | Ripasso + Quiz con risultato immediato</h1>
    <div class="subtitle">
      ‚úÖ Appena scegli una risposta, ricevi subito: <b>giusto/sbagliato + spiegazione</b>.
      <br>In basso trovi anche un <b>recap degli errori</b> per ripassare velocemente.
    </div>
  </div>

  <div class="panel">
    <div class="row">
      <div class="pill">Punteggio: <span id="score">0</span>/<span id="total">0</span></div>
      <div class="pill">Risposte: <span id="answered">0</span>/<span id="qcount">0</span></div>
    </div>
    <div style="height:10px"></div>
    <div class="row">
      <button class="btn" id="resetBtn">Reset</button>
      <button class="btn" id="checkAllBtn">Ricalcola</button>
    </div>
    <div style="height:10px"></div>
    <div class="hint" style="margin:0">
      <span class="mono">Tip:</span> dopo ogni errore, ripeti la regola a voce alta (10 secondi).
    </div>
  </div>
</header>

<main>

  <!-- RIPASSO SLIDE -->
  <section class="card" id="card-slides">
    <h2>Ripasso generale (come slide da leggere) <span class="pill">2 minuti</span></h2>
    <p class="hint">Leggi a voce alta. Poi prova a ripetere a memoria: ‚ÄúPP vs SP, for/since, been/gone, ever/never‚Äù.</p>

    <div class="slides">
      <div class="slide">
        <div class="stitle">Slide 1 ‚Äî Forma del Present Perfect</div>
        <div class="mono">S + have/has + V3 ‚Ä¢ haven‚Äôt/hasn‚Äôt + V3 ‚Ä¢ Have/Has + S + V3?</div>
        <ul>
          <li>He <b>has finished</b> his homework.</li>
          <li><b>Have</b> you <b>ever been</b> to London?</li>
        </ul>
      </div>

      <div class="slide">
        <div class="stitle">Slide 2 ‚Äî Present Perfect: quando si usa</div>
        <ul>
          <li><b>Esperienze</b> (non dici quando): ‚ÄúI have tried sushi.‚Äù</li>
          <li><b>Effetto nel presente</b>: ‚ÄúI have lost my keys.‚Äù</li>
          <li><b>Tempo non finito</b>: ‚Äúthis week / today‚Äù (se non √® finito)</li>
        </ul>
      </div>

      <div class="slide">
        <div class="stitle">Slide 3 ‚Äî Simple Past: quando si usa</div>
        <ul>
          <li><b>Tempo finito/preciso</b>: yesterday, last year, in 2020, ago‚Ä¶</li>
          <li>Fatto ‚Äúchiuso‚Äù nel passato: ‚ÄúI visited London last year.‚Äù</li>
        </ul>
      </div>

      <div class="slide">
        <div class="stitle">Slide 4 ‚Äî Trucco velocissimo</div>
        <ul>
          <li>Se vedi <b>yesterday/last/in 2020/ago</b> ‚Üí <b>Simple Past</b>.</li>
          <li>Se non vedi ‚Äúquando‚Äù ‚Üí spesso <b>Present Perfect</b>.</li>
          <li>Se ‚Äúconta adesso‚Äù (risultato) ‚Üí <b>Present Perfect</b>.</li>
        </ul>
      </div>

      <div class="slide">
        <div class="stitle">Slide 5 ‚Äî For / Since</div>
        <ul>
          <li><b>for</b> + durata: for two hours / for three years</li>
          <li><b>since</b> + inizio: since 2020 / since Monday</li>
        </ul>
      </div>

      <div class="slide">
        <div class="stitle">Slide 6 ‚Äî Have been / Have gone</div>
        <ul>
          <li><b>have been</b> = andato e tornato</li>
          <li><b>have gone</b> = andato ed √® ancora l√¨</li>
        </ul>
      </div>

      <div class="slide">
        <div class="stitle">Slide 7 ‚Äî Ever / Never</div>
        <ul>
          <li><b>ever</b> nelle domande: ‚ÄúHave you ever‚Ä¶?‚Äù</li>
          <li><b>never</b> = mai (senza ‚Äúnot‚Äù): ‚ÄúI have never‚Ä¶‚Äù</li>
          <li>Posizione tipica: have/has + <b>ever/never</b> + V3</li>
        </ul>
      </div>

      <div class="slide">
        <div class="stitle">Slide 8 ‚Äî Esperienze ed emozioni</div>
        <ul>
          <li>Generale: ‚ÄúI have been happy.‚Äù (non dici quando)</li>
          <li>Preciso: ‚ÄúI was nervous yesterday.‚Äù</li>
        </ul>
      </div>
    </div>
  </section>

  <!-- QUIZ TEMPO -->
  <section class="card" id="card-tense">
    <h2>Quiz A ‚Äî Scegli il tempo giusto <span class="pill">12 punti</span></h2>
    <p class="hint">Scegli una risposta: il risultato appare subito sotto con la spiegazione.</p>

    <div class="q" data-id="A1" data-type="mc" data-points="1" data-correct="SP"
         data-explain="C‚Äô√® un tempo finito: ‚Äúlast year‚Äù ‚Üí Simple Past.">
      <div class="qtitle">A1) Tempo corretto</div>
      <div class="prompt">I ____ (visit) London last year.</div>
      <label><input type="radio" name="A1" value="PP">Present Perfect: have visited</label>
      <label><input type="radio" name="A1" value="SP">Simple Past: visited</label>
    </div>

    <div class="q" data-id="A2" data-type="mc" data-points="1" data-correct="PP"
         data-explain="Non dici quando: esperienza di vita ‚Üí Present Perfect.">
      <div class="qtitle">A2) Tempo corretto</div>
      <div class="prompt">I ____ (visit) London.</div>
      <label><input type="radio" name="A2" value="PP">Present Perfect: have visited</label>
      <label><input type="radio" name="A2" value="SP">Simple Past: visited</label>
    </div>

    <div class="q" data-id="A3" data-type="mc" data-points="1" data-correct="PP"
         data-explain="Effetto nel presente: ora non pu√≤ aprire ‚Üí Present Perfect.">
      <div class="qtitle">A3) Tempo corretto</div>
      <div class="prompt">I ____ (lose) my keys. I can‚Äôt open the door.</div>
      <label><input type="radio" name="A3" value="PP">Present Perfect: have lost</label>
      <label><input type="radio" name="A3" value="SP">Simple Past: lost</label>
    </div>

    <div class="q" data-id="A4" data-type="mc" data-points="1" data-correct="SP"
         data-explain="Tempo finito: ‚Äúago‚Äù ‚Üí Simple Past.">
      <div class="qtitle">A4) Tempo corretto</div>
      <div class="prompt">They ____ (arrive) two hours ago.</div>
      <label><input type="radio" name="A4" value="PP">Present Perfect: have arrived</label>
      <label><input type="radio" name="A4" value="SP">Simple Past: arrived</label>
    </div>

    <div class="q" data-id="A5" data-type="mc" data-points="1" data-correct="PP"
         data-explain="‚ÄúThis week‚Äù pu√≤ essere un tempo non finito ‚Üí spesso Present Perfect.">
      <div class="qtitle">A5) Tempo corretto</div>
      <div class="prompt">We ____ (watch) three films this week.</div>
      <label><input type="radio" name="A5" value="PP">Present Perfect: have watched</label>
      <label><input type="radio" name="A5" value="SP">Simple Past: watched</label>
    </div>

    <div class="q" data-id="A6" data-type="mc" data-points="1" data-correct="PP"
         data-explain="‚Äúfor‚Äù + durata (spesso continua fino ad ora) ‚Üí Present Perfect.">
      <div class="qtitle">A6) Tempo corretto</div>
      <div class="prompt">I ____ (live) here for three years.</div>
      <label><input type="radio" name="A6" value="PP">Present Perfect: have lived</label>
      <label><input type="radio" name="A6" value="SP">Simple Past: lived</label>
    </div>

    <div class="q" data-id="A7" data-type="mc" data-points="1" data-correct="GONE"
         data-explain="Non √® qui: √® andata ed √® ancora l√¨ ‚Üí have gone.">
      <div class="qtitle">A7) Been o gone?</div>
      <div class="prompt">Anna isn‚Äôt here. She has ____ to the supermarket.</div>
      <label><input type="radio" name="A7" value="BEEN">been</label>
      <label><input type="radio" name="A7" value="GONE">gone</label>
    </div>

    <div class="q" data-id="A8" data-type="mc" data-points="1" data-correct="BEEN"
         data-explain="√à tornato: been = andato e tornato.">
      <div class="qtitle">A8) Been o gone?</div>
      <div class="prompt">Marco is back home. He has ____ to Milan.</div>
      <label><input type="radio" name="A8" value="BEEN">been</label>
      <label><input type="radio" name="A8" value="GONE">gone</label>
    </div>

    <div class="q" data-id="A9" data-type="mc" data-points="1" data-correct="EVER"
         data-explain="Domanda su esperienza: ‚ÄúHave you ever‚Ä¶?‚Äù">
      <div class="qtitle">A9) Ever o never?</div>
      <div class="prompt">Have you ____ eaten sushi?</div>
      <label><input type="radio" name="A9" value="EVER">ever</label>
      <label><input type="radio" name="A9" value="NEVER">never</label>
    </div>

    <div class="q" data-id="A10" data-type="mc" data-points="1" data-correct="NEVER"
         data-explain="‚Äúnever‚Äù = mai (frase negativa senza ‚Äúnot‚Äù).">
      <div class="qtitle">A10) Ever o never?</div>
      <div class="prompt">I have ____ seen snow.</div>
      <label><input type="radio" name="A10" value="EVER">ever</label>
      <label><input type="radio" name="A10" value="NEVER">never</label>
    </div>

    <div class="q" data-id="A11" data-type="mc" data-points="1" data-correct="SP"
         data-explain="Tempo finito: ‚Äúyesterday‚Äù ‚Üí Simple Past.">
      <div class="qtitle">A11) Tempo corretto</div>
      <div class="prompt">She ____ (finish) her homework yesterday.</div>
      <label><input type="radio" name="A11" value="PP">Present Perfect: has finished</label>
      <label><input type="radio" name="A11" value="SP">Simple Past: finished</label>
    </div>

    <div class="q" data-id="A12" data-type="mc" data-points="1" data-correct="SP"
         data-explain="Momento preciso: ‚Äúin 2021‚Äù ‚Üí Simple Past.">
      <div class="qtitle">A12) Tempo corretto</div>
      <div class="prompt">I ____ (meet) my best friend in 2021.</div>
      <label><input type="radio" name="A12" value="PP">Present Perfect: have met</label>
      <label><input type="radio" name="A12" value="SP">Simple Past: met</label>
    </div>
  </section>

  <!-- QUIZ PERCHE' -->
  <section class="card" id="card-why">
    <h2>Quiz B ‚Äî Scegli il ‚Äúperch√©‚Äù (motivazione) <span class="pill">12 punti</span></h2>
    <p class="hint">Stesse situazioni: scegli il motivo (cos√¨ memorizzi la regola).</p>

    <div class="q" data-id="B1" data-type="mc" data-points="1" data-correct="DEF_TIME"
         data-explain="Past Simple con tempo finito/preciso: yesterday/last/in 2020/ago.">
      <div class="qtitle">B1) Perch√© in A1 si usa Simple Past?</div>
      <div class="prompt">I visited London last year.</div>
      <label><input type="radio" name="B1" value="DEF_TIME">Perch√© c‚Äô√® un tempo finito/preciso (‚Äúlast year‚Äù).</label>
      <label><input type="radio" name="B1" value="LIFE_EXP">Perch√© √® un‚Äôesperienza di vita senza ‚Äúquando‚Äù.</label>
      <label><input type="radio" name="B1" value="RESULT_NOW">Perch√© conta il risultato nel presente.</label>
    </div>

    <div class="q" data-id="B2" data-type="mc" data-points="1" data-correct="LIFE_EXP"
         data-explain="Present Perfect spesso per esperienze (senza dire quando).">
      <div class="qtitle">B2) Perch√© in A2 si usa Present Perfect?</div>
      <div class="prompt">I have visited London.</div>
      <label><input type="radio" name="B2" value="DEF_TIME">Perch√© c‚Äô√® un tempo finito/preciso.</label>
      <label><input type="radio" name="B2" value="LIFE_EXP">Perch√© non dico quando: esperienza di vita.</label>
      <label><input type="radio" name="B2" value="AGO">Perch√© c‚Äô√® ‚Äúago‚Äù.</label>
    </div>

    <div class="q" data-id="B3" data-type="mc" data-points="1" data-correct="RESULT_NOW"
         data-explain="Present Perfect per risultato/effetto nel presente.">
      <div class="qtitle">B3) Perch√© in A3 si usa Present Perfect?</div>
      <div class="prompt">I have lost my keys. I can‚Äôt open the door.</div>
      <label><input type="radio" name="B3" value="RESULT_NOW">Perch√© l‚Äôeffetto √® nel presente.</label>
      <label><input type="radio" name="B3" value="DEF_TIME">Perch√© c‚Äô√® un tempo finito/preciso.</label>
      <label><input type="radio" name="B3" value="SINCE">Perch√© c‚Äô√® ‚Äúsince‚Äù.</label>
    </div>

    <div class="q" data-id="B4" data-type="mc" data-points="1" data-correct="AGO"
         data-explain="‚Äúago‚Äù indica un tempo finito nel passato ‚Üí Simple Past.">
      <div class="qtitle">B4) Perch√© in A4 si usa Simple Past?</div>
      <div class="prompt">They arrived two hours ago.</div>
      <label><input type="radio" name="B4" value="AGO">Perch√© c‚Äô√® ‚Äúago‚Äù.</label>
      <label><input type="radio" name="B4" value="LIFE_EXP">Perch√© √® un‚Äôesperienza di vita.</label>
      <label><input type="radio" name="B4" value="UNFINISHED">Perch√© il tempo non √® finito.</label>
    </div>

    <div class="q" data-id="B5" data-type="mc" data-points="1" data-correct="UNFINISHED"
         data-explain="This week/today pu√≤ essere un periodo non finito ‚Üí spesso Present Perfect.">
      <div class="qtitle">B5) Perch√© in A5 si usa Present Perfect?</div>
      <div class="prompt">We have watched three films this week.</div>
      <label><input type="radio" name="B5" value="UNFINISHED">Perch√© ‚Äúthis week‚Äù pu√≤ essere un tempo non finito.</label>
      <label><input type="radio" name="B5" value="DEF_TIME">Perch√© ‚Äúthis week‚Äù √® un tempo finito.</label>
      <label><input type="radio" name="B5" value="AGO">Perch√© c‚Äô√® ‚Äúago‚Äù.</label>
    </div>

    <div class="q" data-id="B6" data-type="mc" data-points="1" data-correct="DURATION"
         data-explain="For + durata (spesso continua fino ad ora) ‚Üí Present Perfect.">
      <div class="qtitle">B6) Perch√© in A6 si usa Present Perfect?</div>
      <div class="prompt">I have lived here for three years.</div>
      <label><input type="radio" name="B6" value="DURATION">Perch√© ‚Äúfor‚Äù indica durata.</label>
      <label><input type="radio" name="B6" value="DEF_TIME">Perch√© c‚Äô√® un tempo finito/preciso.</label>
      <label><input type="radio" name="B6" value="EVER">Perch√© c‚Äô√® ‚Äúever‚Äù.</label>
    </div>

    <div class="q" data-id="B7" data-type="mc" data-points="1" data-correct="GONE_NOT_HERE"
         data-explain="Have gone = √® andato ed √® ancora l√¨ (non √® qui).">
      <div class="qtitle">B7) Perch√© in A7 la risposta √® ‚Äúgone‚Äù?</div>
      <div class="prompt">Anna isn‚Äôt here. She has gone to the supermarket.</div>
      <label><input type="radio" name="B7" value="GONE_NOT_HERE">Perch√© non √® qui: √® ancora l√¨.</label>
      <label><input type="radio" name="B7" value="BEEN_BACK">Perch√© √® tornata.</label>
      <label><input type="radio" name="B7" value="DEF_TIME">Perch√© c‚Äô√® un tempo finito.</label>
    </div>

    <div class="q" data-id="B8" data-type="mc" data-points="1" data-correct="BEEN_BACK"
         data-explain="Have been = andato e tornato (√® back home).">
      <div class="qtitle">B8) Perch√© in A8 la risposta √® ‚Äúbeen‚Äù?</div>
      <div class="prompt">Marco is back home. He has been to Milan.</div>
      <label><input type="radio" name="B8" value="BEEN_BACK">Perch√© √® tornato: been = andato e tornato.</label>
      <label><input type="radio" name="B8" value="GONE_NOT_HERE">Perch√© non √® qui.</label>
      <label><input type="radio" name="B8" value="EVER">Perch√© √® una domanda con ever.</label>
    </div>

    <div class="q" data-id="B9" data-type="mc" data-points="1" data-correct="EVER_Q"
         data-explain="Ever si usa spesso nelle domande su esperienze.">
      <div class="qtitle">B9) Perch√© in A9 si usa ‚Äúever‚Äù?</div>
      <div class="prompt">Have you ever eaten sushi?</div>
      <label><input type="radio" name="B9" value="EVER_Q">Perch√© √® una domanda ‚ÄúHai mai‚Ä¶?‚Äù.</label>
      <label><input type="radio" name="B9" value="NEVER_NEG">Perch√© √® una frase negativa.</label>
      <label><input type="radio" name="B9" value="DEF_TIME">Perch√© c‚Äô√® un tempo finito.</label>
    </div>

    <div class="q" data-id="B10" data-type="mc" data-points="1" data-correct="NEVER_NEG"
         data-explain="Never = mai, in frase affermativa (senza not).">
      <div class="qtitle">B10) Perch√© in A10 si usa ‚Äúnever‚Äù?</div>
      <div class="prompt">I have never seen snow.</div>
      <label><input type="radio" name="B10" value="NEVER_NEG">Perch√© ‚Äúnever‚Äù = mai (senza ‚Äúnot‚Äù).</label>
      <label><input type="radio" name="B10" value="EVER_Q">Perch√© √® una domanda.</label>
      <label><input type="radio" name="B10" value="AGO">Perch√© c‚Äô√® ‚Äúago‚Äù.</label>
    </div>

    <div class="q" data-id="B11" data-type="mc" data-points="1" data-correct="DEF_TIME"
         data-explain="Yesterday √® tempo finito ‚Üí Simple Past.">
      <div class="qtitle">B11) Perch√© in A11 si usa Simple Past?</div>
      <div class="prompt">She finished her homework yesterday.</div>
      <label><input type="radio" name="B11" value="DEF_TIME">Perch√© ‚Äúyesterday‚Äù √® tempo finito/preciso.</label>
      <label><input type="radio" name="B11" value="RESULT_NOW">Perch√© conta il risultato nel presente.</label>
      <label><input type="radio" name="B11" value="UNFINISHED">Perch√© il tempo non √® finito.</label>
    </div>

    <div class="q" data-id="B12" data-type="mc" data-points="1" data-correct="DEF_TIME"
         data-explain="In 2021 √® un momento preciso ‚Üí Simple Past.">
      <div class="qtitle">B12) Perch√© in A12 si usa Simple Past?</div>
      <div class="prompt">I met my best friend in 2021.</div>
      <label><input type="radio" name="B12" value="DEF_TIME">Perch√© ‚Äúin 2021‚Äù √® un momento preciso.</label>
      <label><input type="radio" name="B12" value="LIFE_EXP">Perch√© non dico quando.</label>
      <label><input type="radio" name="B12" value="DURATION">Perch√© c‚Äô√® ‚Äúfor‚Äù.</label>
    </div>
  </section>

  <!-- RECAP ERRORI -->
  <section class="card" id="card-recap">
    <h2>Recap errori da ripassare <span class="pill">si aggiorna da solo</span></h2>
    <p class="hint">Qui compaiono solo le domande sbagliate, con la spiegazione (cos√¨ ripassi pi√π veloce).</p>
    <ul class="recapList" id="recapList"></ul>
    <div class="feedback warn" id="recapEmpty" style="display:none">
      Nessun errore al momento. Continua cos√¨ üí™
    </div>
  </section>

</main>

<script>
  function norm(s){
    return (s || "").toString().trim().toLowerCase().replace(/\s+/g, " ");
  }

  const allQuestions = Array.from(document.querySelectorAll(".q"));
  const scoreEl = document.getElementById("score");
  const totalEl = document.getElementById("total");
  const answeredEl = document.getElementById("answered");
  const qcountEl = document.getElementById("qcount");
  const resetBtn = document.getElementById("resetBtn");
  const checkAllBtn = document.getElementById("checkAllBtn");
  const recapList = document.getElementById("recapList");
  const recapEmpty = document.getElementById("recapEmpty");

  const totalPoints = allQuestions.reduce((acc, q) => acc + Number(q.dataset.points || 0), 0);
  totalEl.textContent = totalPoints;
  qcountEl.textContent = allQuestions.length;

  // Stato: per ogni domanda: { answered, earned, picked, ok, correct, explain }
  const state = {};
  for(const q of allQuestions){
    const id = q.dataset.id || Math.random().toString(16).slice(2);
    q.dataset.id = id;
    state[id] = { answered:false, earned:0, picked:null, ok:null, correct:q.dataset.correct, explain:q.dataset.explain, points:Number(q.dataset.points||0) };
  }

  function setFeedback(q, kind, html){
    let fb = q.querySelector(".feedback.dynamic");
    if(!fb){
      fb = document.createElement("div");
      fb.className = "feedback dynamic";
      q.appendChild(fb);
    }
    fb.classList.remove("ok","bad","warn");
    fb.classList.add(kind);
    fb.innerHTML = html;
  }

  function checkQuestion(q, showWarningsIfEmpty=false){
    const id = q.dataset.id;
    const points = Number(q.dataset.points || 0);

    const radios = Array.from(q.querySelectorAll('input[type="radio"]'));
    const picked = radios.find(r => r.checked)?.value;

    if(!picked){
      state[id] = { ...state[id], answered:false, earned:0, picked:null, ok:null };
      if(showWarningsIfEmpty){
        setFeedback(q, "warn", "‚è≥ Scegli una risposta.");
      }
      return;
    }

    const correct = q.dataset.correct;
    const ok = norm(picked) === norm(correct);
    const explain = q.dataset.explain ? `<div class="small">Perch√©: ${q.dataset.explain}</div>` : "";

    setFeedback(q, ok ? "ok" : "bad",
      (ok ? "‚úÖ Giusto!" : `‚ùå Sbagliato. Risposta corretta: <b>${correct}</b>.`) + explain
    );

    state[id] = {
      ...state[id],
      answered:true,
      earned: ok ? points : 0,
      picked,
      ok,
      correct,
      explain: q.dataset.explain || "",
      points
    };
  }

  function updateHeaderScore(){
    let earned = 0;
    let answered = 0;

    for(const id in state){
      earned += state[id].earned || 0;
      if(state[id].answered) answered += 1;
    }

    scoreEl.textContent = earned;
    answeredEl.textContent = answered;
  }

  function updateRecap(){
    recapList.innerHTML = "";

    const wrong = Object.entries(state)
      .filter(([_, s]) => s.answered && s.ok === false)
      .map(([id, s]) => ({ id, ...s }));

    if(wrong.length === 0){
      recapEmpty.style.display = "block";
      return;
    }
    recapEmpty.style.display = "none";

    for(const w of wrong){
      const li = document.createElement("li");
      li.className = "recapItem";

      li.innerHTML = `
        <div><b>${w.id}</b> ‚Äî Hai scelto: <b>${w.picked}</b> | Corretto: <b>${w.correct}</b></div>
        <div class="small">Spiegazione: ${w.explain || "‚Äî"}</div>
      `;
      recapList.appendChild(li);
    }
  }

  function recalcAll(){
    // ricontrolla tutto (utile se uno cambia pi√π risposte)
    for(const q of allQuestions){
      checkQuestion(q, true);
    }
    updateHeaderScore();
    updateRecap();
  }

  function resetAll(){
    // reset radios
    document.querySelectorAll('input[type="radio"]').forEach(r => r.checked = false);
    // remove feedback
    document.querySelectorAll(".feedback.dynamic").forEach(el => el.remove());
    // reset state
    for(const id in state){
      state[id].answered = false;
      state[id].earned = 0;
      state[id].picked = null;
      state[id].ok = null;
    }
    updateHeaderScore();
    updateRecap();
    window.scrollTo({ top: 0, behavior: "smooth" });
  }

  // IMMEDIATE CHECK: on change of any radio, check that single question + update score + recap
  document.querySelectorAll('input[type="radio"]').forEach(radio => {
    radio.addEventListener("change", (e) => {
      const q = e.target.closest(".q");
      checkQuestion(q, true);     // immediate feedback + explanation
      updateHeaderScore();        // immediate score update
      updateRecap();              // immediate recap update
    });
  });

  // Buttons
  resetBtn.addEventListener("click", resetAll);
  checkAllBtn.addEventListener("click", recalcAll);

  // Init recap empty
  updateHeaderScore();
  updateRecap();
</script>

</body>
</html>
